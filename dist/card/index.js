'use strict';var _toConsumableArray2=require('babel-runtime/helpers/toConsumableArray'),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_promise=require('babel-runtime/core-js/promise'),_promise2=_interopRequireDefault(_promise),_assign=require('babel-runtime/core-js/object/assign'),_assign2=_interopRequireDefault(_assign),_classCallCheck2=require('babel-runtime/helpers/classCallCheck'),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require('babel-runtime/helpers/createClass'),_createClass3=_interopRequireDefault(_createClass2),_index=require('../index.js'),_comm=require('../comm.js'),_verge=require('verge'),_verge2=_interopRequireDefault(_verge);Object.defineProperty(exports,'__esModule',{value:!0}),exports.CardBoard=void 0;function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var CardBoard=exports.CardBoard=function(){function a(){(0,_classCallCheck3.default)(this,a),this.DOC=document,this.deviceHeight=_verge2.default.viewportH(),this.cardBoardContainer={},this.cardBoards=[],this.default={},this.setting={},this.init=this.init.bind(this),this.pinCardBoard=this.pinCardBoard.bind(this),this.scrollHandler=this.scrollHandler.bind(this),this.setCardEFStyle=this.setCardEFStyle.bind(this),this.removeCardEFStyle=this.removeCardEFStyle.bind(this),this.pin=this.pin.bind(this),this.start=this.start.bind(this),this.pause=this.pause.bind(this),this.clientOS=(0,_comm.getClientOS)(),this.randomMAX=1e9,this.randomMIN=10,this.initVersion=Math.floor(Math.random()*(this.randomMAX-this.randomMIN+1))+this.randomMIN}return(0,_createClass3.default)(a,[{key:'init',value:function init(b){var d=b.container,e=void 0===d?'body':d,f=b.option;return this.cardBoardContainer=this.DOC.querySelector(e),this.default={cardBoardContainer:'.cardBoard',lastCardTransparent:!1,offset:0},this.setting=(0,_assign2.default)({},this.default,f),_comm.isSafari&&'Mac OS'===this.clientOS&&(this.setting.offset=0),_promise2.default.all([this.pinCardBoard()])}},{key:'pause',value:function pause(){window.removeEventListener('scroll',this.scrollHandler)}},{key:'start',value:function start(){window.addEventListener('scroll',this.scrollHandler)}},{key:'pinCardBoard',value:function pinCardBoard(){var b=this;return new _promise2.default(function(d){var e=[].concat((0,_toConsumableArray3.default)(b.cardBoardContainer.querySelectorAll(b.setting.cardBoardContainer)));e&&0<e.length&&(e.map(function(f,g){var h=b.DOC.createElement('div');h.setAttribute('class','CB-BACK'),h.setAttribute('style','position: absolute; height: 100%; width: 100%; top: 0; left: 0;');var j='.'+f.getAttribute('class').split(' ').join('.')+'.KCCB-'+g;(0,_comm.addClass)(f,'KCCB-'+g);var k=(0,_index.elmYPosition)(j),l=f.getAttribute('style'),m=f.getAttribute('o-height'),n=f.getAttribute('raw-style'),o=n?g===e.length-1?(0,_comm.trim)(n+' z-index: 102;'):(0,_comm.trim)(n+' height: '+(+(m||f.clientHeight)+b.setting.offset)+'px; z-index: 102;'):g===e.length-1?(0,_comm.trim)((l?l:'')+' z-index: 102;'):(0,_comm.trim)((l?l:'')+' height: '+(+(m||f.clientHeight)+b.setting.offset)+'px; z-index: 102;');f.insertBefore(h,f.children[0]),f.setAttribute('style',o),m||f.setAttribute('o-height',f.clientHeight),n||f.setAttribute('raw-style',l||''),b.cardBoards.push({id:j,ele:f,eleTopY:k,eleBtmY:k+f.clientHeight,cardOStyle:o})}),b.start()),d(b.cardBoards)})}},{key:'cleanHeight',value:function cleanHeight(b){return new _promise2.default(function(d){b.map(function(e,f){var g='.'+e.getAttribute('class').split(' ').join('.')+'.KCCB-'+f,h=e.getAttribute('style'),j=e.getAttribute('o-height');e.setAttribute('style',h.replace('height: '+j+'px; z-index: 102;','')),e.removeAttribute('o-height')}),d()})}},{key:'scrollHandler',value:function scrollHandler(){var b=this,d=(0,_index.currentYPosition)(),e=d+this.deviceHeight;console.log('scroll detected'),_comm.isSafari&&'Mac OS'===this.clientOS||this.cardBoards.map(function(f,g){f.eleBtmY-b.setting.offset<e&&f.eleBtmY>d&&g!==b.cardBoards.length-1?(b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle+' opacity: '+(f.eleBtmY-d)/b.deviceHeight+';'),b.setCardEFStyle({id:f.id,ele:f.ele,eleBtmY:f.eleBtmY,currTopY:d}).then(function(h){return b.pin({id:f.id,ele:f.ele,eleBtmY:f.eleBtmY,currTopY:d,children:h})})):(f.eleBtmY-b.setting.offset>=e?b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle):b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle+' opacity: 0;'),b.removeCardEFStyle({id:f.id,ele:f.ele,eleBtmY:f.eleBtmY,i:g}))})}},{key:'setCardEFStyle',value:function setCardEFStyle(b){var d=this,e=b.id,f=b.ele,g=b.eleBtmY,h=b.currTopY;return new _promise2.default(function(j){var k=[].concat((0,_toConsumableArray3.default)(f.children));k&&0<k.length&&k.map(function(l){var m=l.getAttribute('o-style'),n=l.getAttribute('a-style');if(!(n&&m)){var o=l.getAttribute('initv'),p=l.getAttribute('style'),q=+window.getComputedStyle(l,null).paddingBottom.replace('px',''),r=+window.getComputedStyle(l,null).paddingTop.replace('px',''),s='none'!==window.getComputedStyle(l,null).float,t=l.getAttribute('class'),u=l.offsetLeft,v=l.clientWidth,w=l.clientHeight,x=(0,_index.elmYPosition)(e+' .'+t.split(' ').join('.')),y=x-(g-d.deviceHeight-d.setting.offset);l.setAttribute('initv',d.initVersion),l.setAttribute('a-style','position: fixed; top: '+y+'px; left: '+u+'px; z-index: 99; width: '+v+'px;'),l.setAttribute('o-style',(p||'')+'height: '+(s?w+'px;':w-r-q+'px;'))}}),j(k)})}},{key:'pin',value:function pin(b){var d=b.id,e=b.ele,f=b.eleBtmY,g=b.currTopY,h=b.children;return new _promise2.default(function(j){h&&0<h.length&&h.map(function(k){var l=k.getAttribute('a-style'),m=k.getAttribute('o-style');l&&m&&k.setAttribute('style',''+m+l)}),j()})}},{key:'removeCardEFStyle',value:function removeCardEFStyle(b){var d=b.id,e=b.ele,f=b.eleBtmY,g=b.i;return new _promise2.default(function(h){var j=[].concat((0,_toConsumableArray3.default)(e.children));j&&0<j.length?j.map(function(k){var l=k.getAttribute('style'),m=k.getAttribute('o-style')||l||'';k.setAttribute('style',m),h()}):h()})}}]),a}();