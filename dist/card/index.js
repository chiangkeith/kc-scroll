'use strict';var _toConsumableArray2=require('babel-runtime/helpers/toConsumableArray'),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_promise=require('babel-runtime/core-js/promise'),_promise2=_interopRequireDefault(_promise),_assign=require('babel-runtime/core-js/object/assign'),_assign2=_interopRequireDefault(_assign),_classCallCheck2=require('babel-runtime/helpers/classCallCheck'),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require('babel-runtime/helpers/createClass'),_createClass3=_interopRequireDefault(_createClass2),_index=require('../index.js'),_comm=require('../comm.js'),_verge=require('verge'),_verge2=_interopRequireDefault(_verge);Object.defineProperty(exports,'__esModule',{value:!0}),exports.CardBoard=void 0;function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var CardBoard=exports.CardBoard=function(){function a(){(0,_classCallCheck3.default)(this,a),this.DOC=document,this.deviceHeight=_verge2.default.viewportH(),this.cardBoardContainer={},this.cardBoards=[],this.default={},this.setting={},this.init=this.init.bind(this),this.pinCardBoard=this.pinCardBoard.bind(this),this.scrollHandler=this.scrollHandler.bind(this),this.setCardEFStyle=this.setCardEFStyle.bind(this),this.removeCardEFStyle=this.removeCardEFStyle.bind(this),this.start=this.start.bind(this),this.pause=this.pause.bind(this),this.cleanCss=this.cleanCss.bind(this),this.setCss=this.setCss.bind(this),this.randomMAX=1e9,this.randomMIN=10,this.initVersion=Math.floor(Math.random()*(this.randomMAX-this.randomMIN+1))+this.randomMIN}return(0,_createClass3.default)(a,[{key:'init',value:function init(b){var d=b.container,e=void 0===d?'body':d,f=b.option;return this.cardBoardContainer=this.DOC.querySelector(e),this.default={cardBoardContainer:'.cardBoard',lastCardTransparent:!1,offset:0},this.setting=(0,_assign2.default)({},this.default,f),_promise2.default.all([this.pinCardBoard()])}},{key:'pause',value:function pause(){window.removeEventListener('scroll',this.scrollHandler)}},{key:'start',value:function start(){window.addEventListener('scroll',this.scrollHandler)}},{key:'pinCardBoard',value:function pinCardBoard(){var b=this;return new _promise2.default(function(d){var e=[].concat((0,_toConsumableArray3.default)(b.cardBoardContainer.querySelectorAll(b.setting.cardBoardContainer)));e&&0<e.length&&(e.map(function(f,g){var h='.'+f.getAttribute('class').split(' ').join('.')+'.KCCB-'+g;(0,_comm.addClass)(f,'KCCB-'+g);var j=(0,_index.elmYPosition)(h),k=f.getAttribute('style'),l=f.getAttribute('o-height'),m=f.getAttribute('raw-style'),n=m?(0,_comm.trim)(m+' height: '+(+(l||f.clientHeight)+b.setting.offset)+'px; z-index: 102;'):(0,_comm.trim)((k?k:'')+' height: '+(+(l||f.clientHeight)+b.setting.offset)+'px; z-index: 102;');f.setAttribute('style',n),l||f.setAttribute('o-height',f.clientHeight),m||f.setAttribute('raw-style',k||''),b.cardBoards.push({id:h,ele:f,eleTopY:j,eleBtmY:j+f.clientHeight,cardOStyle:n})}),b.start()),d(b.cardBoards)})}},{key:'refreshCardBoard',value:function refreshCardBoard(){var b=this;return this.cardBoards=[],this.deviceHeight=_verge2.default.viewportH(),this.initVersion=Math.floor(Math.random()*(this.randomMAX-this.randomMIN+1))+this.randomMIN,new _promise2.default(function(d){var e=[].concat((0,_toConsumableArray3.default)(b.cardBoardContainer.querySelectorAll(b.setting.cardBoardContainer)));e&&0<e.length?b.cleanHeight(e).then(function(){setTimeout(function(){return b.pinCardBoard().then(function(){d(b.cardBoards)})},50)}):d(b.cardBoards)})}},{key:'cleanHeight',value:function cleanHeight(b){return new _promise2.default(function(d){b.map(function(e,f){var g='.'+e.getAttribute('class').split(' ').join('.')+'.KCCB-'+f,h=e.getAttribute('style'),j=e.getAttribute('o-height');e.setAttribute('style',h.replace('height: '+j+'px; z-index: 102;','')),e.removeAttribute('o-height')}),d()})}},{key:'cleanCss',value:function cleanCss(b){var d=b.ele,e=b.currStyle,f=b.rawStyle,g=b.oStyle;return new _promise2.default(function(h){for(var j=g?g.split(';'):[],k=e,l=0;l<j.length;l+=1)k=k.replace(j[l]+';','');d.setAttribute('style',k),d.setAttribute('raw-style',k),d.removeAttribute('o-style'),d.removeAttribute('a-style'),h()})}},{key:'scrollHandler',value:function scrollHandler(){var b=this;console.log('scroll');var d=(0,_index.currentYPosition)(),e=d+this.deviceHeight;this.cardBoards.map(function(f,g){f.eleBtmY-b.setting.offset<e&&f.eleBtmY>d?(b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle+' opacity: '+(f.eleBtmY-d)/b.deviceHeight+';'),b.setCardEFStyle({id:f.id,ele:f.ele,eleBtmY:f.eleBtmY,currTopY:d})):(f.eleBtmY-b.setting.offset>=e?b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle):b.setting.lastCardTransparent&&f.ele.setAttribute('style',f.cardOStyle+' opacity: 0;'),b.removeCardEFStyle({id:f.id,ele:f.ele,eleBtmY:f.eleBtmY,i:g}))})}},{key:'setCardEFStyle',value:function setCardEFStyle(b){var d=this,e=b.id,f=b.ele,g=b.eleBtmY,h=b.currTopY;return new _promise2.default(function(j){var k=[].concat((0,_toConsumableArray3.default)(f.children));k&&0<k.length&&(k.map(function(l){var m=l.getAttribute('o-style'),n=l.getAttribute('a-style'),o=l.getAttribute('initv'),p=l.getAttribute('raw-style'),q=l.getAttribute('style');if(d.initVersion!=o)return null==o?void d.setCss({id:e,child:l,eleBtmY:g,rawStyle:p,childStyle:q}):void d.cleanCss({ele:l,rawStyle:p,currStyle:q,oStyle:m}).then(function(){return console.log('clean and set css',e),l.setAttribute('initv',d.initVersion),d.setCss({id:e,child:l,eleBtmY:g,rawStyle:p,childStyle:q})})}),k.map(function(l){var m=l.getAttribute('a-style'),n=l.getAttribute('o-style');m&&n&&l.setAttribute('style',''+n+m)})),j()})}},{key:'setCss',value:function setCss(b){var d=this,e=b.child,f=b.eleBtmY,g=b.id,h=b.rawStyle,j=b.childStyle;return new _promise2.default(function(k){var l=+window.getComputedStyle(e,null).paddingBottom.replace('px',''),m=+window.getComputedStyle(e,null).paddingTop.replace('px',''),n='none'!==window.getComputedStyle(e,null).float,o=e.getAttribute('class'),p=e.offsetLeft,q=e.clientWidth,r=e.clientHeight,s=(0,_index.elmYPosition)(g+' .'+o.split(' ').join('.')),t=f-(s+r)-d.setting.offset;h||e.setAttribute('raw-style',j||''),e.setAttribute('initv',d.initVersion),e.setAttribute('a-style','position: fixed; bottom: '+t+'px; left: '+p+'px; z-index: 99; width: '+q+'px; padding-top: '+m+'px; padding-bottom: '+l+'px;'),h?e.setAttribute('o-style',(h||'')+'height: '+(n?r+'px;':r-m-l+'px; padding-top: '+m+'px; padding-bottom: '+l+'px;')):e.setAttribute('o-style',(j||'')+'height: '+(n?r+'px;':r-m-l+'px; padding-top: '+m+'px; padding-bottom: '+l+'px;')),k()})}},{key:'removeCardEFStyle',value:function removeCardEFStyle(b){var d=this,e=b.id,f=b.ele,g=b.eleBtmY,h=b.i;return new _promise2.default(function(j){var k=[].concat((0,_toConsumableArray3.default)(f.children));k&&0<k.length?k.map(function(l){var m=l.getAttribute('initv'),n=l.getAttribute('raw-style'),o=l.getAttribute('style'),p=l.getAttribute('o-style')||o||'';if(1===h&&console.log('449'),d.initVersion!=m&&m)console.log('clean',e),d.cleanCss({ele:l,rawStyle:n,currStyle:o,oStyle:p}).then(function(){1===h&&console.log('458'),j()});else{1===h&&console.log('463');var q=l.getAttribute('o-style')||o||'';l.setAttribute('style',q),j()}}):j()})}}]),a}();